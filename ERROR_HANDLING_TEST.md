# エラーハンドリングテストガイド

## 📋 テストチェックリスト

### 1. ネットワークエラーテスト

#### テスト手順

1. Rails バックエンドを停止

   ```bash
   cd /Users/nakanomasaki/My_projects/meal-planner
   docker compose stop backend
   ```

2. アプリで献立生成を試す

#### 期待される結果

- ✅ エラーメッセージ: "ネットワーク接続を確認してください。"
- ✅ "もう一度試す" ボタンが表示される
- ✅ リトライボタンを押すと再度 API 呼び出しを試みる

#### 後処理

```bash
docker compose start backend
```

---

### 2. タイムアウトエラーテスト

#### テスト手順

1. `frontend/config/environment.ts` を編集

   ```typescript
   timeout: 1000,  // 30000 から 1000 に変更
   ```

2. フロントエンドをリロード

3. 献立生成を試す（OpenAI 処理に時間がかかる）

#### 期待される結果

- ✅ エラーメッセージ: "リクエストがタイムアウトしました。もう一度お試しください。"
- ✅ 自動的に 2 回リトライされる（ログで確認）
- ✅ リトライボタンで再実行可能

#### 後処理

```typescript
timeout: 30000,  // 元に戻す
```

---

### 3. リトライ機能テスト

#### テスト手順

1. ネットワークエラー状態にする（バックエンド停止）
2. 献立生成を実行
3. ブラウザ/デバッグコンソールでログを確認

#### 期待される結果

- ✅ ログに "API 呼び出し試行 1/3" と表示
- ✅ ログに "API 呼び出し試行 2/3" と表示
- ✅ ログに "API 呼び出し試行 3/3" と表示
- ✅ 各試行の間に待機時間がある（1 秒 →2 秒 →4 秒）
- ✅ 最終的にエラーメッセージが表示される

---

### 4. OpenAI API エラーテスト

#### テスト手順 A: API 認証エラー

1. 環境変数を変更

   ```bash
   export OPENAI_API_KEY="invalid-test-key"
   docker compose restart backend
   ```

2. 献立生成を試す

#### 期待される結果

- ✅ バックエンドログに "OpenAI API error: AuthenticationError" が記録
- ✅ モック献立が生成される（フォールバック動作）
- ✅ フロントエンドでは正常に献立が表示される

#### 後処理

```bash
export OPENAI_API_KEY="your-actual-api-key"
docker compose restart backend
```

#### テスト手順 B: レート制限エラー

※実際にレート制限に達するまで連続で API 呼び出し

#### 期待される結果

- ✅ エラーメッセージ: "API の利用制限に達しました。しばらく待ってから再度お試しください。"
- ✅ フォールバックでモック献立生成

---

### 5. サーバーエラーテスト（5xx）

#### テスト手順

1. Rails コントローラーに意図的にエラーを発生させる

   ```ruby
   # app/controllers/api/v1/meal_plans_controller.rb
   def generate
     raise StandardError, "Test server error"  # テスト用
   end
   ```

2. 献立生成を試す

#### 期待される結果

- ✅ エラーメッセージ: "サーバーで問題が発生しました。しばらく待ってから再度お試しください。"
- ✅ リトライボタンで再実行可能

#### 後処理

テスト用コードを削除

---

### 6. UI 動作テスト

#### テスト項目

- [ ] エラー発生時、献立カードは表示されない
- [ ] エラーカードが赤色の背景で表示される
- [ ] ⚠️ アイコンがエラーメッセージと共に表示される
- [ ] "もう一度試す" ボタンが表示される
- [ ] ボタンを押すと再度 API 呼び出しが実行される
- [ ] ローディング中は "もう一度試す" ボタンが無効化される
- [ ] 食材未選択時はボタンが無効化される
- [ ] エラー解消後、エラーカードが消える

---

### 7. ログ確認テスト

#### フロントエンドログ確認

```
[2025-10-31T...] MealPlanAPI INFO: API呼び出し試行 1/3
[2025-10-31T...] MealPlanAPI WARN: リトライまで1000ms待機
[2025-10-31T...] MealPlanAPI ERROR: Rails API呼び出し例外
```

#### バックエンドログ確認

```bash
docker compose logs backend -f
```

期待されるログ:

```
OpenAI API error: OpenAI::RateLimitError - Rate limit exceeded
Falling back to mock generation due to: APIの利用制限に達しました
```

---

## 🎯 成功基準

### 必須項目

- ✅ すべてのエラータイプで適切なメッセージが表示される
- ✅ リトライ機能が正しく動作する
- ✅ "もう一度試す" ボタンが機能する
- ✅ エラー状態でもアプリがクラッシュしない

### 推奨項目

- ✅ エラーログが詳細に記録される
- ✅ OpenAI エラー時にフォールバックが動作する
- ✅ ユーザーフレンドリーなエラーメッセージ

---

## 📝 テスト記録テンプレート

| テスト項目         | 実施日 | 結果 | メモ |
| ------------------ | ------ | ---- | ---- |
| ネットワークエラー |        | ⬜   |      |
| タイムアウトエラー |        | ⬜   |      |
| リトライ機能       |        | ⬜   |      |
| OpenAI 認証エラー  |        | ⬜   |      |
| サーバーエラー     |        | ⬜   |      |
| UI 動作            |        | ⬜   |      |
| ログ出力           |        | ⬜   |      |

---

## 🐛 バグ発見時の対応

1. エラー内容を記録
2. 再現手順を明確にする
3. スクリーンショットを撮る
4. ログを保存
5. Issue を作成または修正
